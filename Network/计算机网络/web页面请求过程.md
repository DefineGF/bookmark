##### DHCP

1. 个人PC通过 以太网电缆 连接 以太网交换机；
2. OS 生成 DHCP 请求报文：
    - UDP-目的端口：67
    - IP数据报：目的ip地址：255.255.255.255；源 IP 地址：0.0.0.0
    - 以太网帧：目的MAX地址：FF:FF:FF:FF:FF:FF；源MAC地址：个人MAC地址
3. 以太网帧发送到交换机
    - 交换机自学习记录源MAC地址对应的接口；
    - 交换机广播此帧，其MAC地址为广播地址；
4. 帧 -> 路由器
    1. 路由器提取IP数据报，发现广播目的IP地址；交由高层协议 即 UDP 协议处理，自此获得DHCP请求；
    2. 路由器生成DHCP ACK 报文段，UDP：
        - 分配的IP地址，网络掩码
        - DNS服务器IP地址；
        - 默认网关路由器的IP地址；
    3. 网络层将其封装成 目的地址为：255.255.255.255 的IP数据报；进而封装成以太网帧
5. 以太网帧发送到交换机：通过自学习创建的转发表准确地将帧转发到个人PC；
6. 个人PC接收到帧之后，获得分配的IP及相关信息；

（不同网络中传世，MAC源地址和目的地址都会发生变化）



#### DNS 和 ARP

欲访问网址，需知其IP地址，故需DNS；

但使用DNS时，很多时候DNS服务器与请求主机不在同一子网，故需将DNS查询报文发送到默认网关，其目的MAC地址应该为默认网关的MAC地址。而当前主机因DHCP只知道默认网关的IP地址。

因此需要使用ARP协议来获取默认网关的MAC地址。



##### ARP协议（网络层）

1. 主机生成ARP查询报文 （目的地址：默认网关IP）-> 以太网帧（目的MAC地址：FF：FF：FF：FF：FF：FF）

2. 帧 -> 交换机 -> 路由器

    - 网关路由器自ARP查询报文中，匹配其目的IP地址；
    - 生成 MAC应答：指示网关的MAC地址，目的MAC地址为：请求方MAC地址

3. 帧 -> 个人PC

    个人PC获得默认网关的MAC地址

##### DNS 应用层

1. 主机生成 DNS 请求报文（UDP）：

    - 目的端口号：53；
    - 目的IP地址：DNS服务器地址；
    - 目的MAC地址：默认网关MAC

2. 网关路由器接收帧：

    - 获得目的IP地址，查询路由器表，得到下一跳的输出端口号；
    - 修改目的MAC地址（MAC同一广播域不会变化，跨之则修改）

3. 帧 -> ...  -> DNS 服务器

    - DNS服务器获取查询报文内容；
    - 生成DNS回答报文；

4. 帧 -> 个人PC

    获得目的网址的ip地址