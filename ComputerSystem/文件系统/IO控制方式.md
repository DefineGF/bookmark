### IO控制方式

#### 程序直接控制方式

##### 过程

1. CPU预设传送参数；
2. CPU -> 命令字 -> IO接口，启动IO
3. CPU不断查询设备状态信息（from 设备状态寄存器）

传送：

1. 一次一个字；修改地址 & 计数器参数；
2. while 结束；



#### 中断驱动方式

1. CPU -> IO控制器 ；然后CPU做其他事情；IO做数据传输准备；

2. IO：数据 -> 数据寄存器

    ​        中断信号 -> 控制线 -> CPU

3. CPU 每个指令周期末检查中断；如果存在中断申请：

    - 保存上下文
    - 中断处理程序 -> 处理中断

传输数据通过程序完成。

鼠标键盘一般采用中断方式；



#### DMA：直接存储器存储 

内存 <----> 外设

##### DMA控制器之寄存器

- MAR 主存地址寄存器：内存起始 / 目的 地址
- DR 数据寄存器
- DC 数据计数器
- CR 命令/状态寄存器

其余：DMA请求触发器；控制/状态 逻辑；中断机构



##### 过程

- 预处理：

    - CPU -> DMA 

        - 设寄存器处置：主存起始地址；IO设备地址；数据个数
        - 传送方向

    - 启动设备；IO准备好要发送或者接收数据；

    - 设备向DMA控制器发出DMA请求信号（DRQ），可以发生在每个机器周期结束后；

        DMA控制器向CPU发出总线请求信号（HRQ）；

- 数据传送：

    DMA 控制系统总线（地址，数据，控制）；

    以单字节（或 字）或者 数据块为基本单位；（完全由DMA硬件控制）

- 后处理

    1. DMA ->  CPU：中断请求

    2. CPU -> 中断服务程序

        检验送入主存的数据是否正确；测试传送过程是否出错；决定是否使用DMA传送其他数据；

预处理和后处理均需要CPU的介入：

- 预处理时无需中断现行程序，无需保护现场，仅仅从CPU获取总线控制权；
- 后处理需要中断；

##### 冲突处理

IO 设备（DMA控制器） 与 CPU同时访问主存，可能发生冲突；

- 停止CPU访问主存
- DMA 与 CPU交替访问主存：总线使用权由两者分时控制；
- 周期挪用（周期窃取）：
    - CPU访存；
    - CPU正访存，须待存取周期结束，CPU交出总线控制权；
    - 同时访存，CPU暂时放弃；由IO设备挪用一个或者几个存取周期；



#### 通道控制

DMA的发展；对一组数据块为控制管理单位；

通道是一个特殊的处理器，具有执行IO指令的功能，并通过执行通道程序来完成相关功能；



##### 过程

CPU -> IO指令 -> IO 通道 : 



##### 与DMA区别

- DMA 需 CPU控制传输数据块的大小、内存位置；但是通道自己控制；
- 一DMA控制器对应一台设备与内存；而通道控制多台设备与内存的数据交换；



通道程序存放于主存中而非通道：由通道从主存中取出并由通道执行；

具有通道结构的机器中，IO指令不实现数据传送；而是主要完成：

- 开启/关闭IO设备
- 查询通道、IO设备状态；
- 控制通道进行其他操作；

